<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å†…éƒ¨é€šå ±çª“å£ - AIãƒãƒ£ãƒƒãƒˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #1a1a1a;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
    }

    .header {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 16px 16px 0 0;
      padding: 24px 32px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
    }

    .chat-container {
      background: white;
      border-radius: 0 0 16px 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      height: 600px;
      display: flex;
      flex-direction: column;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message {
      display: flex;
      gap: 12px;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.ai {
      align-self: flex-start;
    }

    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 20px;
    }

    .message.ai .message-avatar {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .message.user .message-avatar {
      background: #f3f4f6;
      color: #667eea;
    }

    .message-content {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.6;
      font-size: 15px;
    }

    .message.ai .message-content {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .message.user .message-content {
      background: #667eea;
      color: white;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 8px;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #667eea;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    .chat-input-area {
      border-top: 1px solid #e5e7eb;
      padding: 20px;
      display: flex;
      gap: 12px;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 15px;
      font-family: 'Noto Sans JP', sans-serif;
      resize: none;
      min-height: 50px;
      max-height: 120px;
    }

    .chat-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .send-button {
      padding: 12px 24px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Noto Sans JP', sans-serif;
      align-self: flex-end;
    }

    .send-button:hover:not(:disabled) {
      background: #5568d3;
      transform: translateY(-1px);
    }

    .send-button:disabled {
      background: #d1d5db;
      cursor: not-allowed;
    }

    .file-upload-area {
      display: none;
      margin-top: 12px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 8px;
      border: 2px dashed #d1d5db;
    }

    .file-upload-area.active {
      display: block;
    }

    .quick-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .quick-action-btn {
      padding: 8px 16px;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Noto Sans JP', sans-serif;
    }

    .quick-action-btn:hover {
      border-color: #667eea;
      background: #f5f7ff;
    }

    .mode-switch {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .mode-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      font-family: 'Noto Sans JP', sans-serif;
    }

    .mode-btn.active {
      border-color: #667eea;
      background: #f5f7ff;
      color: #667eea;
    }

    .summary-box {
      background: #eff6ff;
      border: 1px solid #93c5fd;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }

    .summary-title {
      font-weight: 600;
      color: #1e40af;
      margin-bottom: 8px;
    }

    .summary-content {
      font-size: 14px;
      color: #1e40af;
      line-height: 1.6;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      .header {
        padding: 16px 20px;
      }
      .chat-container {
        height: calc(100vh - 120px);
      }
      .message-content {
        max-width: 85%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        ğŸ›¡ï¸ å†…éƒ¨é€šå ±çª“å£
      </div>
    </div>

    <div style="background: white; padding: 20px; border-bottom: 1px solid #e5e7eb;">
      <div class="mode-switch">
        <button class="mode-btn active" onclick="switchMode('chat')">AIãƒãƒ£ãƒƒãƒˆï¼ˆæ¨å¥¨ï¼‰</button>
        <button class="mode-btn" onclick="switchMode('form')">ç°¡æ˜“ãƒ•ã‚©ãƒ¼ãƒ </button>
      </div>
    </div>

    <div id="chatMode" class="chat-container">
      <div class="chat-messages" id="chatMessages"></div>
      
      <div class="chat-input-area">
        <textarea 
          class="chat-input" 
          id="chatInput" 
          placeholder="ã“ã¡ã‚‰ã«å…¥åŠ›ã—ã¦ãã ã•ã„..."
          rows="1"
        ></textarea>
        <button class="send-button" id="sendButton" onclick="sendMessage()">é€ä¿¡</button>
      </div>
    </div>

    <div id="formMode" class="hidden">
      <div style="background: white; padding: 40px; border-radius: 0 0 16px 16px;">
        <p style="text-align: center; color: #666;">ç°¡æ˜“ãƒ•ã‚©ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã¯ç¾åœ¨ã®é€šå ±ãƒ•ã‚©ãƒ¼ãƒ ã¨åŒã˜ã§ã™ã€‚</p>
        <p style="text-align: center; color: #666; margin-top: 12px;">
          <a href="https://whistleblower-system-i8im.vercel.app/" style="color: #667eea;">å¾“æ¥ã®ãƒ•ã‚©ãƒ¼ãƒ ã¯ã“ã¡ã‚‰</a>
        </p>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // ğŸ”§ é‡è¦: ã“ã“ã«Gemini APIã‚­ãƒ¼ã‚’è¨­å®š
    // ============================================
    const GEMINI_API_KEY = 'AIzaSyB1IIYgGomUqTQhEUBasGlfJYhZnn1kfgc';
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxSAdId-tHF2Xc9PpFrpj_nAl--YaiEKIYHE_6Ukee2ncaQk92hi85DvcKsu7M0XxBjVg/exec';

    let conversationHistory = [];
    let collectedData = {};
    let isProcessing = false;

    // åˆæœŸåŒ–
    window.onload = function() {
      startConversation();
    };

    function startConversation() {
      const welcomeMessage = `ã“ã‚“ã«ã¡ã¯ã€‚å†…éƒ¨é€šå ±çª“å£ã¸ã‚ˆã†ã“ãã€‚

ç§ã¯AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã‚ãªãŸã®é€šå ±å†…å®¹ã‚’ä¸å¯§ã«ãŠä¼ºã„ã—ã¾ã™ã€‚

**ã‚ãªãŸã®åŒ¿åæ€§ã¯å®Œå…¨ã«ä¿è­·ã•ã‚Œã¾ã™ã€‚å®‰å¿ƒã—ã¦ãŠè©±ã—ãã ã•ã„ã€‚**

ã¾ãšã€ã©ã®ã‚ˆã†ãªå‡ºæ¥äº‹ã«ã¤ã„ã¦é€šå ±ã•ã‚ŒãŸã„ã§ã™ã‹ï¼Ÿ
ç°¡å˜ã§æ§‹ã„ã¾ã›ã‚“ã®ã§ã€æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ`;

      addMessage('ai', welcomeMessage);
      conversationHistory.push({
        role: 'user',
        parts: [{text: 'ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ã‚ãªãŸã¯å†…éƒ¨é€šå ±çª“å£ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚è¦ªã—ã¿ã‚„ã™ãå„ªã—ã„å£èª¿ã§ã€å…±æ„Ÿã—ãªãŒã‚‰ä¸å¯§ã«ãƒ’ã‚¢ãƒªãƒ³ã‚°ã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®æƒ…å ±ã‚’æ®µéšçš„ã«åé›†ã—ã¦ãã ã•ã„ï¼š1.é€šå ±å†…å®¹ã€2.ç™ºç”Ÿæ—¥æ™‚ãƒ»å ´æ‰€ã€3.é–¢ä¿‚è€…æƒ…å ±ã€4.ç›®æ’ƒè€…æƒ…å ±ã€5.è¨¼æ‹ è³‡æ–™ã€6.é€šå ±è€…ã®æ„Ÿæƒ…ã€7.è¢«å®³ã®ç¨‹åº¦ã€8.å¸Œæœ›ã™ã‚‹å¯¾å¿œã€9.é€£çµ¡å…ˆæä¾›ã®å¯å¦ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œåˆ†ã‹ã‚‰ãªã„ã€ã¨ç­”ãˆã¦ã‚‚ã€å„ªã—ãæ·±æ˜ã‚Šã—ã¦ãã ã•ã„ã€‚'}]
      });
      conversationHistory.push({
        role: 'model',
        parts: [{text: welcomeMessage}]
      });
    }

    function addMessage(type, content) {
      const messagesDiv = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = type === 'ai' ? 'ğŸ¤–' : 'ğŸ‘¤';
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.innerHTML = content.replace(/\n/g, '<br>');
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(contentDiv);
      messagesDiv.appendChild(messageDiv);
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showTyping() {
      const messagesDiv = document.getElementById('chatMessages');
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message ai';
      typingDiv.id = 'typingIndicator';
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = 'ğŸ¤–';
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
      
      typingDiv.appendChild(avatar);
      typingDiv.appendChild(contentDiv);
      messagesDiv.appendChild(typingDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function hideTyping() {
      const typing = document.getElementById('typingIndicator');
      if (typing) typing.remove();
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message || isProcessing) return;
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      addMessage('user', message);
      input.value = '';
      input.style.height = 'auto';
      
      // å‡¦ç†ä¸­ãƒ•ãƒ©ã‚°
      isProcessing = true;
      document.getElementById('sendButton').disabled = true;
      
      // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
      showTyping();
      
      // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
      conversationHistory.push({
        role: 'user',
        parts: [{text: message}]
      });
      
      try {
        // Gemini APIã‚’å‘¼ã³å‡ºã—
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: conversationHistory,
            generationConfig: {
              temperature: 0.7,
              maxOutputTokens: 1000,
            }
          })
        });

        const data = await response.json();
        hideTyping();
        
        if (data.candidates && data.candidates[0]) {
          const aiResponse = data.candidates[0].content.parts[0].text;
          
          // AIã®å¿œç­”ã‚’è¡¨ç¤º
          addMessage('ai', aiResponse);
          
          // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
          conversationHistory.push({
            role: 'model',
            parts: [{text: aiResponse}]
          });
          
          // ä¼šè©±ãŒçµ‚äº†ã—ãŸã‹åˆ¤å®š
          checkIfComplete(aiResponse);
        } else {
          throw new Error('APIå¿œç­”ãŒä¸æ­£ã§ã™');
        }
        
      } catch (error) {
        hideTyping();
        console.error('ã‚¨ãƒ©ãƒ¼:', error);
        addMessage('ai', 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ä¸€æ™‚çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      }
      
      isProcessing = false;
      document.getElementById('sendButton').disabled = false;
      input.focus();
    }

    function checkIfComplete(aiResponse) {
      // ã€Œæœ€å¾Œã«ã€ã€Œã”ç¢ºèªã€ãªã©ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§å®Œäº†ã‚’åˆ¤å®š
      if (aiResponse.includes('æœ€å¾Œã«') || aiResponse.includes('ä»¥ä¸Šã§') || aiResponse.includes('ã”ç¢ºèª')) {
        // è¦ç´„ã¨é€ä¿¡ã®å‡¦ç†
        setTimeout(() => {
          addMessage('ai', 'é€šå ±å†…å®¹ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„...');
          setTimeout(submitReport, 2000);
        }, 1000);
      }
    }

    async function submitReport() {
      try {
        // ä¼šè©±å±¥æ­´ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¦Google Sheetsã«é€ä¿¡
        const summary = conversationHistory
          .filter(msg => msg.role === 'user')
          .map(msg => msg.parts[0].text)
          .join('\n');

        const submitData = {
          action: 'newReport',
          timestamp: new Date().toISOString(),
          incidentDescription: summary,
          incidentDate: '',
          incidentTime: '',
          incidentLocation: '',
          involvedPersons: '',
          witnessInfo: '',
          files: []
        };

        await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(submitData)
        });

        const trackingNumber = 'WB-' + Date.now().toString().slice(-8);
        
        addMessage('ai', `âœ… **é€šå ±ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ**

å—ä»˜ç•ªå·: **${trackingNumber}**

ã“ã®ç•ªå·ã¯å¿…ãšä¿å­˜ã—ã¦ãã ã•ã„ã€‚å¾Œã‹ã‚‰è¿½åŠ æƒ…å ±ã‚’é€ä¿¡ã™ã‚‹éš›ã«å¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ã”é€šå ±ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚å†…å®¹ã¯ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹æ‹…å½“è€…ã«é€šçŸ¥ã•ã‚Œã€é©åˆ‡ã«å¯¾å¿œã„ãŸã—ã¾ã™ã€‚`);

      } catch (error) {
        console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        addMessage('ai', 'é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æã‚Œå…¥ã‚Šã¾ã™ãŒã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      }
    }

    // Enterã‚­ãƒ¼ã§é€ä¿¡ï¼ˆShift+Enterã§æ”¹è¡Œï¼‰
    document.getElementById('chatInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚º
    document.getElementById('chatInput').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    function switchMode(mode) {
      const chatMode = document.getElementById('chatMode');
      const formMode = document.getElementById('formMode');
      const buttons = document.querySelectorAll('.mode-btn');
      
      buttons.forEach(btn => btn.classList.remove('active'));
      
      if (mode === 'chat') {
        chatMode.classList.remove('hidden');
        formMode.classList.add('hidden');
        buttons[0].classList.add('active');
      } else {
        chatMode.classList.add('hidden');
        formMode.classList.remove('hidden');
        buttons[1].classList.add('active');
      }
    }
  </script>
</body>
</html>
